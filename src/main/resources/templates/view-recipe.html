<!DOCTYPE html>
<html>
<head>
    <title>Recipe Details - RecipeVault</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sanitize-html@2.9.0/dist/sanitize-html.min.js"></script>
    <style>
        /* Base Styles */
        :root {
            --primary: #2c7be5;
            --primary-dark: #1a68d1;
            --primary-light: #5995e8;
            --secondary: #33b07c;
            --background-dark: #121212;
            --background: #1e1e1e;
            --background-light: #2d2d2d;
            --card-bg: #262626;
            --text: #e9ecef;
            --text-muted: #adb5bd;
            --text-secondary: #83888e;
            --border: #383838;
            --error: #e63757;
            --success: #33b07c;
            --card-radius: 12px;
            --button-radius: 8px;
            --transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.18);
            --fixed-width: 896px; /* Equivalent to max-w-4xl */
        }
        
        /* Light theme variables */
        [data-theme="light"] {
            --primary: #1e62c0;
            --primary-dark: #1754a3;
            --primary-light: #4785d6;
            --secondary: #2a9363;
            --background-dark: #e9ecef;
            --background: #f8f9fa;
            --background-light: #ffffff;
            --card-bg: #ffffff;
            --text: #212529;
            --text-muted: #6c757d;
            --text-secondary: #495057;
            --border: #dee2e6;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.12);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background);
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.5;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
            min-width: var(--fixed-width);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--background-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 6px;
            opacity: 0.6;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        /* Main layout */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        header {
            background: var(--background-dark);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .header-content {
            width: var(--fixed-width);
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            box-shadow: var(--shadow-md);
        }
        
        .brand-container {
            display: flex;
            flex-direction: column;
        }
        
        .brand {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.02em;
            transition: color 0.3s ease;
        }
        
        .tagline {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 400;
            letter-spacing: 0.01em;
            transition: color 0.3s ease;
        }
        
        /* Theme toggle */
        .theme-toggle {
            background: var(--background-light);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            height: 40px;
            width: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .theme-toggle:hover {
            background: var(--border);
            color: var(--text);
            transform: rotate(15deg);
        }
        
        /* Container */
        .container {
            width: var(--fixed-width);
            margin: 0 auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        /* Back button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: var(--button-radius);
            background: var(--background-light);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: var(--transition);
            text-decoration: none;
            width: fit-content;
            margin-bottom: 1.5rem;
        }
        
        .back-btn:hover {
            background: var(--card-bg);
            color: var(--text);
            transform: translateX(-4px);
        }
        
        .back-btn i {
            margin-right: 0.5rem;
        }
        
        /* Recipe Header */
        .recipe-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            padding-bottom: 1.5rem;
        }
        
        .recipe-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 3px;
        }
        
        .recipe-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 0.5rem;
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 0.4rem 1rem;
            background: rgba(44, 123, 229, 0.15);
            color: var(--primary);
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .tag:hover {
            background: rgba(44, 123, 229, 0.25);
            transform: translateY(-2px);
        }
        
        /* Recipe Layout */
        .recipe-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        /* Recipe Card */
        .recipe-card {
            background: var(--card-bg);
            border-radius: var(--card-radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            transition: box-shadow 0.3s ease;
        }
        
        .recipe-card:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            background: var(--background-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .card-title i {
            color: var(--primary);
            font-size: 1.2rem;
        }
        
        .card-content {
            padding: 1.5rem;
        }
        
        /* Ingredients and Instructions */
        .ingredients-list, .instructions {
            color: var(--text);
            line-height: 1.7;
            font-size: 1rem;
        }
        
        .ingredients-list ul, .instructions ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .ingredients-list li, .instructions li {
            margin-bottom: 0.75rem;
        }
        
        /* Health Tips Section */
        .health-tips-section {
            background: var(--card-bg);
            border-radius: var(--card-radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            transition: box-shadow 0.3s ease;
            margin-bottom: 2rem;
        }
        
        .health-tips-section:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .health-tips-header {
            padding: 1.25rem 1.5rem;
            background: var(--background-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }
        
        .health-tips-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .health-tips-title i {
            color: var(--secondary);
            font-size: 1.2rem;
        }
        
        .health-tips-content {
            padding: 1.5rem;
            display: none; /* Initially hidden */
        }
        
        .view-tips-btn {
            padding: 0.6rem 1.2rem;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: var(--button-radius);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .view-tips-btn:hover {
            background: var(--secondary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(51, 176, 124, 0.3);
        }
        
        /* Alternatives Section */
        .alternatives-section {
            background: var(--card-bg);
            border-radius: var(--card-radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            transition: box-shadow 0.3s ease;
        }
        
        .alternatives-section:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .alternatives-header {
            padding: 1.25rem 1.5rem;
            background: var(--background-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }
        
        .alternatives-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var (--text);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .alternatives-title i {
            color: var(--primary);
            font-size: 1.2rem;
        }
        
        .alternatives-content {
            padding: 1.5rem;
        }
        
        .alternatives-intro {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }
        
        /* Ingredient Items */
        .ingredient-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .ingredient-item {
            background: var(--background-light);
            border-radius: var(--button-radius);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            border: 1px solid var(--border);
        }
        
        .ingredient-item:hover {
            background: rgba(44, 123, 229, 0.1);
            transform: translateY(-2px);
        }
        
        .ingredient-name {
            font-size: 0.95rem;
            color: var(--text);
        }
        
        .alternative-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .alternative-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .alternative-btn i {
            font-size: 0.75rem;
        }
        
        /* Results Container */
        .results-container {
            background: var(--background-light);
            border-radius: var(--button-radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid var(--border);
            display: none;
        }
        
        /* Allergy Form */
        .allergy-form {
            margin-top: 2.5rem;
            background: var(--background-light);
            border-radius: var(--card-radius);
            padding: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .allergy-form-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }
        
        .form-input {
            flex: 1;
            padding: 0.85rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--button-radius);
            background: var(--background);
            color: var(--text);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 123, 229, 0.2);
        }
        
        .form-input:hover {
            border-color: var(--primary-light);
        }
        
        .btn {
            padding: 0.85rem 1.5rem;
            border: none;
            border-radius: var(--button-radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(44, 123, 229, 0.3);
        }
        
        .loading {
            display: inline-block;
            margin-left: 0.5rem;
            font-style: italic;
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        /* Footer */
        footer {
            background: var(--background-dark);
            padding: 2rem;
            margin-top: auto;
            text-align: center;
            border-top: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .footer-content {
            width: var(--fixed-width);
            margin: 0 auto;
        }
        
        .footer-text {
            color: var(--text-secondary);
            font-size: 0.85rem;
            transition: color 0.3s ease;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        .footer-link {
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition);
            font-size: 0.85rem;
            position: relative;
        }
        
        .footer-link:hover {
            color: var(--primary);
        }
        
        .footer-link::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: width 0.3s ease;
        }
        
        .footer-link:hover::after {
            width: 100%;
        }
        
        /* Markdown content styling */
        .markdown-content {
            color: var(--text);
            line-height: 1.7;
            font-size: 1rem;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            color: var(--primary);
            margin-top: 1.2em;
            margin-bottom: 0.6em;
            font-weight: 600;
        }
        
        .markdown-content p {
            margin-bottom: 1em;
        }
        
        .markdown-content ul,
        .markdown-content ol {
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        
        .markdown-content li {
            margin-bottom: 0.5em;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo"><i class="fas fa-utensils"></i></div>
                    <div class="brand-container">
                        <h1 class="brand">RecipeVault</h1>
                        <p class="tagline">Professional Recipe Management</p>
                    </div>
                </div>
                <button class="theme-toggle" id="themeToggle" title="Toggle dark/light mode">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </header>

        <div class="main-content">
            <div class="container">
                <a href="/" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Recipes</span>
                </a>
                
                <div class="recipe-header">
                    <h1 class="recipe-title" id="recipeTitle">Homemade Pasta Carbonara</h1>
                    <div class="tags-container" id="recipeTags">
                        <span class="tag"><i class="fas fa-tag"></i> Italian</span>
                        <span class="tag"><i class="fas fa-tag"></i> Pasta</span>
                        <span class="tag"><i class="fas fa-tag"></i> Dinner</span>
                    </div>
                </div>
                
                <div class="recipe-layout">
                    <!-- Ingredients Card -->
                    <div class="recipe-card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-list"></i> Ingredients
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="ingredients-list markdown-content" id="ingredientsList">
                                Loading ingredients...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Instructions Card -->
                    <div class="recipe-card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-utensils"></i> Instructions
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="instructions markdown-content" id="instructionsList">
                                Loading instructions...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Health Tips Section -->
                    <div class="health-tips-section">
                        <div class="health-tips-header">
                            <div class="health-tips-title">
                                <i class="fas fa-heart"></i> Health Tips
                            </div>
                            <div> <!-- Wrapper for button and loader -->
                                <button class="view-tips-btn" id="viewTipsBtn">
                                    <i class="fas fa-eye"></i> View Tips
                                </button>
                                <span id="tipsLoading" class="loading" style="display:none;">Loading...</span>
                            </div>
                        </div>
                        <div class="health-tips-content markdown-content" id="healthTipsContent" style="display: none;">
                            <!-- Health tips will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Alternatives Section -->
                    <div class="alternatives-section">
                        <div class="alternatives-header">
                            <div class="alternatives-title">
                                <i class="fas fa-exchange-alt"></i> Ingredient Alternatives
                            </div>
                        </div>
                        <div class="alternatives-content">
                            <p class="alternatives-intro">Select an ingredient to see alternatives:</p>
                            
                            <div class="ingredient-items" id="processedIngredients">
                                <!-- Ingredient items will be generated here -->
                            </div>
                            
                            <div id="alternativeResults" class="results-container markdown-content">
                                Select an ingredient to see alternatives.
                            </div>
                            
                            <div class="allergy-form">
                                <h3 class="allergy-form-title"><i class="fas fa-allergies"></i> Get Allergy-Safe Substitutes</h3>
                                <div class="form-group">
                                    <input type="text" id="ingredient" class="form-input" placeholder="Enter ingredient">
                                    <input type="text" id="allergies" class="form-input" placeholder="Enter allergies (e.g., nuts, dairy)">
                                    <button id="allergyBtn" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Get Substitutes
                                    </button>
                                </div>
                                <span id="allergyLoading" class="loading" style="display:none;">Thinking...</span>
                                <div id="allergyResults" class="results-container markdown-content">
                                    Enter an ingredient and allergies to find safe substitutes.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <div class="footer-content">
                <p class="footer-text">© 2025 RecipeVault - Enterprise Recipe Management Solution</p>
                <div class="footer-links">
                    <a href="#" class="footer-link">About</a>
                    <a href="#" class="footer-link">Terms</a>
                    <a href="#" class="footer-link">Privacy</a>
                    <a href="#" class="footer-link">Support</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Sample recipe data (in a real app, this would come from the server)
        const recipeData = {
            title: "Homemade Pasta Carbonara",
            tags: ["Italian", "Pasta", "Dinner"],
            ingredients: `- 400g spaghetti
- 200g pancetta or guanciale, diced
- 4 large eggs
- 100g Pecorino Romano cheese, grated
- 100g Parmigiano Reggiano, grated
- 2 cloves garlic, minced
- Freshly ground black pepper
- Salt to taste
- Fresh parsley, chopped (for garnish)`,
            instructions: `1. Bring a large pot of salted water to a boil. Add the spaghetti and cook until al dente according to package instructions.

2. While the pasta is cooking, heat a large skillet over medium heat. Add the diced pancetta or guanciale and cook until crispy and the fat has rendered, about 8-10 minutes.

3. In a bowl, whisk together the eggs, grated cheeses, and a generous amount of freshly ground black pepper.

4. When the pasta is done, reserve 1 cup of the pasta water, then drain the pasta.

5. Working quickly, add the hot pasta to the skillet with the pancetta. Toss to coat the pasta in the rendered fat.

6. Remove the skillet from the heat and quickly pour in the egg and cheese mixture, stirring constantly to create a creamy sauce. If the sauce is too thick, add a splash of the reserved pasta water to thin it out.

7. Serve immediately, garnished with additional grated cheese, freshly ground black pepper, and chopped parsley.`
        };

        // Initialize markdown-it
        const md = window.markdownit({
            html: true,
            breaks: true,
            linkify: true,
            typographer: true
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Theme toggle functionality
            const themeToggle = document.getElementById('themeToggle');
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            
            // Check for saved theme preference or use preferred color scheme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);
            } else {
                // Use system preference as default
                const systemTheme = prefersDarkScheme.matches ? 'dark' : 'light';
                document.body.setAttribute('data-theme', systemTheme);
                updateThemeIcon(systemTheme);
            }
            
            // Update icon based on current theme
            function updateThemeIcon(theme) {
                const icon = themeToggle.querySelector('i');
                if (theme === 'light') {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                } else {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
            }
            
            // Toggle theme when button is clicked
            themeToggle.addEventListener('click', function() {
                const currentTheme = document.body.getAttribute('data-theme') || 'dark';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                // Apply theme change with animation
                anime({
                    targets: 'body',
                    opacity: [1, 0.96, 1],
                    duration: 300,
                    easing: 'easeInOutQuad',
                    begin: function() {
                        document.body.setAttribute('data-theme', newTheme);
                        localStorage.setItem('theme', newTheme);
                        updateThemeIcon(newTheme);
                    }
                });
            });
            
            // Populate recipe data
            document.getElementById('recipeTitle').textContent = recipeData.title;
            
            // Clear and populate tags
            const tagsContainer = document.getElementById('recipeTags');
            tagsContainer.innerHTML = '';
            recipeData.tags.forEach(tag => {
                const tagSpan = document.createElement('span');
                tagSpan.className = 'tag';
                tagSpan.innerHTML = `<i class="fas fa-tag"></i> ${tag}`;
                tagsContainer.appendChild(tagSpan);
            });
            
            // Format and render ingredients
            const ingredientsElement = document.getElementById('ingredientsList');
            ingredientsElement.innerHTML = md.render(recipeData.ingredients);
            
            // Format and render instructions
            const instructionsElement = document.getElementById('instructionsList');
            instructionsElement.innerHTML = md.render(recipeData.instructions);
            
            // Process ingredients for alternatives
            const processedIngredients = document.getElementById('processedIngredients');
            processedIngredients.innerHTML = '';
            
            // Parse ingredients from markdown
            const ingredientLines = recipeData.ingredients.split('\n')
                .filter(line => line.trim().startsWith('-'))
                .map(line => line.replace('-', '').trim());
            
            // Create interactive ingredient items
            ingredientLines.forEach((ingredient, index) => {
                // Extract the main ingredient name (before any commas or parentheses)
                const mainIngredient = ingredient.split(',')[0].split('(')[0].trim();
                
                // Remove quantities and measurements for the ingredient name
                const cleanedIngredient = mainIngredient.replace(/^\d+(\.\d+)?(g|kg|ml|l|cups?|tbsp|tsp|oz|pounds?|lbs?)?/i, '').trim();
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'ingredient-item fade-in';
                itemDiv.innerHTML = `
                    <span class="ingredient-name">${ingredient}</span>
                    <button class="alternative-btn" onclick="getAlternative('${cleanedIngredient.replace(/'/g, "\\'")}')">
                        <i class="fas fa-exchange-alt"></i> Alternatives
                    </button>
                `;
                processedIngredients.appendChild(itemDiv);
                
                // Add staggered animation
                setTimeout(() => {
                    itemDiv.style.opacity = 1;
                }, 100 + index * 50);
            });
            
            // --- MODIFIED Health Tips Button Logic ---
            const viewTipsBtn = document.getElementById('viewTipsBtn');
            const healthTipsContent = document.getElementById('healthTipsContent');
            const tipsLoading = document.getElementById('tipsLoading');
            let tipsLoaded = false; // Flag to track if tips have been loaded

            viewTipsBtn.addEventListener('click', async function() {
                // Toggle visibility if tips are already loaded
                if (tipsLoaded) {
                    const isVisible = healthTipsContent.style.display === 'block';
                    if (isVisible) {
                        // Hide with animation
                        anime({
                            targets: healthTipsContent,
                            opacity: [1, 0],
                            translateY: [0, 10],
                            duration: 300,
                            easing: 'easeInQuad',
                            complete: function() {
                                healthTipsContent.style.display = 'none';
                                viewTipsBtn.innerHTML = '<i class="fas fa-eye"></i> View Tips';
                            }
                        });
                    } else {
                        // Show with animation
                        healthTipsContent.style.display = 'block';
                        viewTipsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Tips';
                        anime({
                            targets: healthTipsContent,
                            opacity: [0, 1],
                            translateY: [10, 0],
                            duration: 400,
                            easing: 'easeOutQuad'
                        });
                    }
                    return; // Exit if just toggling
                }

                // --- Fetch tips if not loaded ---
                viewTipsBtn.disabled = true;
                tipsLoading.style.display = 'inline-block';
                healthTipsContent.innerHTML = ''; // Clear previous content
                healthTipsContent.style.display = 'block'; // Show container for loading text

                // TODO: Replace '1' with the actual recipe ID from Thymeleaf or URL
                const recipeId = '1'; 

                try {
                    const response = await fetch(`/api/recipes/${recipeId}/health-tips`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const tipsText = await response.text();
                    
                    // Render fetched tips using markdown-it
                    healthTipsContent.innerHTML = md.render(tipsText || "No health tips available.");
                    tipsLoaded = true; // Mark tips as loaded
                    viewTipsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Tips'; // Update button text
                    
                    // Animate content appearance
                    anime({
                        targets: healthTipsContent,
                        opacity: [0, 1],
                        translateY: [10, 0],
                        duration: 400,
                        easing: 'easeOutQuad'
                    });

                } catch (error) {
                    console.error('Error fetching health tips:', error);
                    healthTipsContent.innerHTML = '<p style="color: var(--error);">Could not load health tips. Please try again later.</p>';
                    // Keep button as "View Tips" on error, don't set tipsLoaded to true
                    viewTipsBtn.innerHTML = '<i class="fas fa-eye"></i> View Tips'; 
                } finally {
                    // Hide loading indicator and re-enable button regardless of success/failure
                    tipsLoading.style.display = 'none';
                    viewTipsBtn.disabled = false;
                }
            });
            
            // Set up allergy button
            document.getElementById('allergyBtn').addEventListener('click', getAllergySafeSubstitutes);
        });
        
        // Helper function to format Gemini API responses
        function formatGeminiResponse(response) {
            // Split response into sections if it contains bullet points
            const lines = response.split('\n');
            let formattedResponse = '';

            // Check if response has bullet points
            const hasBulletPoints = lines.some(line => line.trim().startsWith('•') || line.trim().startsWith('-'));

            if (hasBulletPoints) {
                // Process each line
                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('•') || trimmedLine.startsWith('-')) {
                        // Convert bullets to markdown list items
                        formattedResponse += `- ${trimmedLine.substring(1).trim()}\n`;
                    } else if (trimmedLine.length > 0) {
                        // Add paragraphs for non-list text
                        formattedResponse += `${trimmedLine}\n\n`;
                    }
                });
            } else {
                // Format as paragraphs if no bullet points
                formattedResponse = lines
                    .filter(line => line.trim().length > 0)
                    .join('\n\n');
            }

            // Render the markdown
            return md.render(formattedResponse);
        }
        
        // Function to get alternatives for an ingredient
        function getAlternative(ingredient) {
            const alternativeResults = document.getElementById('alternativeResults');
            
            // Show loading state
            alternativeResults.style.display = 'block';
            alternativeResults.innerHTML = `<p>Finding alternatives for <strong>${ingredient}</strong>...</p>`;
            
            // Simulate API call with setTimeout (in a real app, this would be a fetch to your backend)
            setTimeout(() => {
                // Sample alternatives data (in a real app, this would come from the API)
                let alternatives;
                
                switch(ingredient.toLowerCase()) {
                    case 'pancetta':
                    case 'guanciale':
                        alternatives = `
## Alternatives for Pancetta/Guanciale

- **Bacon**: The most common substitute, though it has a smokier flavor
- **Prosciutto**: Less fatty but adds a nice salty flavor
- **Smoked Ham**: Works well when diced finely
- **For Vegetarian Option**: Smoked tofu or tempeh with a bit of olive oil and salt
                        `;
                        break;
                    case 'pecorino romano':
                        alternatives = `
## Alternatives for Pecorino Romano

- **Parmigiano Reggiano**: Slightly milder but works well
- **Grana Padano**: Similar texture with a more delicate flavor
- **Aged Asiago**: Good substitute with a slightly sharper taste
- **For Dairy-Free Option**: Nutritional yeast mixed with a pinch of salt
                        `;
                        break;
                    case 'parmigiano reggiano':
                        alternatives = `
## Alternatives for Parmigiano Reggiano

- **Pecorino Romano**: Sharper and saltier
- **Grana Padano**: Very similar flavor profile
- **Aged Manchego**: Different but compatible flavor
- **For Dairy-Free Option**: Nutritional yeast with a bit of almond meal
                        `;
                        break;
                    case 'spaghetti':
                        alternatives = `
## Alternatives for Spaghetti

- **Linguine**: Slightly wider but works perfectly
- **Fettuccine**: Wider pasta that holds the sauce well
- **Bucatini**: Hollow spaghetti that adds an interesting texture
- **For Gluten-Free Option**: Rice noodles or gluten-free pasta
- **For Low-Carb Option**: Zucchini noodles or spaghetti squash
                        `;
                        break;
                    default:
                        alternatives = `
## Alternatives for ${ingredient}

- No specific alternatives found for this ingredient.
- Try searching for a more specific ingredient name.
                        `;
                }
                
                // Render the alternatives with markdown
                alternativeResults.innerHTML = md.render(alternatives);
                
                // Add animation
                anime({
                    targets: '#alternativeResults',
                    opacity: [0, 1],
                    translateY: [10, 0],
                    duration: 400,
                    easing: 'easeOutQuad'
                });
            }, 800);
        }
        
        // Function to get allergy-safe substitutes
        function getAllergySafeSubstitutes() {
            const ingredient = document.getElementById('ingredient').value.trim();
            const allergies = document.getElementById('allergies').value.trim();
            
            if (!ingredient || !allergies) {
                alert('Please enter both an ingredient and allergies');
                return;
            }
            
            const allergyResults = document.getElementById('allergyResults');
            const loadingElement = document.getElementById('allergyLoading');
            
            // Show loading state
            loadingElement.style.display = 'inline-block';
            allergyResults.style.display = 'block';
            allergyResults.innerHTML = 'Searching for allergy-safe substitutes...';
            
            // Simulate API call with setTimeout (in a real app, this would be a fetch to your backend)
            setTimeout(() => {
                // Sample response data (in a real app, this would come from the API)
                let response;
                
                if (ingredient.toLowerCase().includes('cheese') && allergies.toLowerCase().includes('dairy')) {
                    response = `
## Dairy-Free Alternatives for Cheese

- **Nutritional Yeast**: Provides a cheesy flavor without dairy
- **Cashew Cheese**: Made from soaked cashews, nutritional yeast, and seasonings
- **Coconut-Based Cheese**: Commercial options available in most grocery stores
- **Tofu-Based Cheese**: Good for recipes that require melting
                    `;
                } else if (ingredient.toLowerCase().includes('milk') && allergies.toLowerCase().includes('dairy')) {
                    response = `
## Dairy-Free Alternatives for Milk

- **Almond Milk**: Light flavor, works well in most recipes
- **Oat Milk**: Creamy texture, great for cooking
- **Coconut Milk**: Rich option, adds coconut flavor
- **Soy Milk**: Protein-rich alternative with neutral taste
                    `;
                } else if (ingredient.toLowerCase().includes('flour') && allergies.toLowerCase().includes('gluten')) {
                    response = `
## Gluten-Free Alternatives for Flour

- **Rice Flour**: Light texture, mild flavor
- **Almond Flour**: Adds moisture and nutty flavor
- **Chickpea Flour**: High protein content, good for savory dishes
- **Gluten-Free Flour Blend**: Commercial blends designed to substitute 1:1 for wheat flour
                    `;
                } else {
                    response = `
## Allergy-Safe Alternatives for ${ingredient}

Based on your allergies (${allergies}), consider these substitutes:

- Option 1: Alternative ingredient with similar properties
- Option 2: Different approach to achieve similar results
- Option 3: Complete replacement that avoids allergens

Always check product labels carefully as manufacturing processes may introduce cross-contamination.
                    `;
                }
                
                // Hide loading indicator
                loadingElement.style.display = 'none';
                
                // Render the response with markdown
                allergyResults.innerHTML = md.render(response);
                
                // Add animation
                anime({
                    targets: '#allergyResults',
                    opacity: [0, 1],
                    translateY: [10, 0],
                    duration: 400,
                    easing: 'easeOutQuad'
                });
            }, 1200);
        }
    </script>
</body>
</html>